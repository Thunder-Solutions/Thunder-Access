"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,r=new Array(e.length);t<e.length;t++)r[t]=e[t];return r}}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}Object.defineProperty(exports,"__esModule",{value:!0});var errorPrefix="Problem evaluating accessibility",logError=function(e){"undefined"==typeof jest&&console.error("".concat(errorPrefix,": ").concat(e))},throwError=function(e){throw new Error("".concat(errorPrefix,": ").concat(e))},checkSelectorValidity=function(e){var t="string"==typeof e,r=!0;try{getRoot().querySelector(e)}catch(e){r=!1}var n=t&&r;return n||logError("".concat(e," is not a valid selector.")),n},getTabbableElements=function(){return _toConsumableArray(getRoot().querySelectorAll('\n    a:not([disabled]):not([tabindex="-1"]),\n    button:not([disabled]):not([tabindex="-1"]),\n    input:not([disabled]):not([tabindex="-1"]),\n    [tabindex]:not([disabled]):not([tabindex="-1"])\n  ')).filter((function(e){return!e.closest('[aria-hidden="true"]')||!!e.offsetParent}))},Events={_listeners:{addQueue:[],removeQueue:[],current:new Map},add:function(e,t,r){this._listeners.addQueue.push({selector:e,event:t,listener:r})},removeAll:function(e){this._listeners.removeQueue.push(e)},update:function(){var e=this._listeners;e.addQueue.forEach((function(t){var r=t.selector,n=t.event,a=t.listener,o=e.current.get(r)||[];o.find((function(e){return e.event===n&&String(e.listener)===String(a)}))||_toConsumableArray(document.querySelectorAll(r)).forEach((function(t){t.addEventListener(n,a),o.push({event:n,listener:a}),e.current.set(r,o)}))})),e.removeQueue.forEach((function(t){var r=e.current.get(t);if(r){var n=[];r.forEach((function(r){var a=r.event,o=r.listener;if(e.addQueue.filter((function(e){return e.selector===t})).find((function(e){return e.event===a&&String(e.listener)===String(o)})))return n.push({event:a,listener:o});_toConsumableArray(document.querySelectorAll(t)).forEach((function(e){return e.removeEventListener(a,o)}))})),e.current.set(t,n)}})),e.removeQueue=[],e.addQueue=[]}},rootObj={element:null},getRoot=function(){return rootObj.element||"undefined"!=typeof document&&document.body||throwError("Could not find the root element.")},swapAndPop=function(e,t){var r=e.length-1,n=e[r],a=e[t];return e[r]=a,e[t]=n,e.pop()},domState=new Map,getElementState=function(e){return domState.get(e)||domState.set(e,{inlineAttributes:Array.from(e.attributes),attributeObserver:null,screenReaderElement:null,methods:{},rules:{}}),domState.get(e)},updateElementState=function(e,t){var r=getElementState(e);domState.set(e,t(r))},calculateSingle=function(e){var t,r,n=e,a={a:0,b:0,c:0},o=[];return t=function(t,r){var i,u,c,l,s,d;if(t.test(n))for(u=0,c=(i=n.match(t)).length;u<c;u+=1)a[r]+=1,l=i[u],s=n.indexOf(l),d=l.length,o.push({selector:e.substr(s,d),type:r,index:s,length:d}),n=n.replace(l,Array(d+1).join(" "))},(r=function(e){var t,r,a,o;if(e.test(n))for(r=0,a=(t=n.match(e)).length;r<a;r+=1)o=t[r],n=n.replace(o,Array(o.length+1).join("A"))})(/\\[0-9A-Fa-f]{6}\s?/g),r(/\\[0-9A-Fa-f]{1,5}\s/g),r(/\\./g),function(){var e,t,r,a,o=/{[^]*/gm;if(o.test(n))for(t=0,r=(e=n.match(o)).length;t<r;t+=1)a=e[t],n=n.replace(a,Array(a.length+1).join(" "))}(),t(/(\[[^\]]+\])/g,"b"),t(/(#[^\#\s\+>~\.\[:\)]+)/g,"a"),t(/(\.[^\s\+>~\.\[:\)]+)/g,"b"),t(/(::[^\s\+>~\.\[:]+|:first-line|:first-letter|:before|:after)/gi,"c"),t(/(:(?!not|global|local)[\w-]+\([^\)]*\))/gi,"b"),t(/(:(?!not|global|local)[^\s\+>~\.\[:]+)/g,"b"),n=(n=(n=(n=(n=(n=n.replace(/[\*\s\+>~]/g," ")).replace(/[#\.]/g," ")).replace(/:not/g,"    ")).replace(/:local/g,"      ")).replace(/:global/g,"       ")).replace(/[\(\)]/g," "),t(/([^\s\+>~\.\[:]+)/g,"c"),o.sort((function(e,t){return e.index-t.index})),{selector:e,specificity:"0,"+a.a.toString()+","+a.b.toString()+","+a.c.toString(),specificityArray:[0,a.a,a.b,a.c],parts:o}},compare=function(e,t){var r,n,a;if("string"==typeof e){if(-1!==e.indexOf(","))throw"Invalid CSS selector";r=calculateSingle(e).specificityArray}else{if(!Array.isArray(e))throw"Invalid CSS selector or specificity array";if(4!==e.filter((function(e){return"number"==typeof e})).length)throw"Invalid specificity array";r=e}if("string"==typeof t){if(-1!==t.indexOf(","))throw"Invalid CSS selector";n=calculateSingle(t).specificityArray}else{if(!Array.isArray(t))throw"Invalid CSS selector or specificity array";if(4!==t.filter((function(e){return"number"==typeof e})).length)throw"Invalid specificity array";n=t}for(a=0;a<4;a+=1){if(r[a]<n[a])return-1;if(r[a]>n[a])return 1}return 0},updateAttributes=function(e){var t=getElementState(e),r=t.inlineAttributes,n=t.rules,a=function(t,n){var a=e.getAttribute(t)===String(n),o=!!r.find((function(e){return e.name===t}));if(["class","id","style"].includes(t)||t.startsWith("on"))return logError('Cannot assign black-listed attribute: "'.concat(t,'"'));o||a||e.setAttribute(t,n)};Object.keys(n).forEach((function(t){if(e.matches(t)){var r=n[t],o=r.aria,i=r.attr;o&&Object.keys(o).forEach((function(e){return a("aria-".concat(e),o[e])})),i&&Object.keys(i).forEach((function(e){return a(e,i[e])}))}}))},focus=function(e){if(e instanceof HTMLElement)return e.focus();if(e.constructor!==String)return logError("the `focus()` method expects either an element or a string.");var t=getTabbableElements(),r=t.findIndex((function(e){return e===document.activeElement})),n=t.length-1;switch(e){case"next":t[r<n?r+1:0].focus();break;case"previous":t[r>0?r-1:n].focus();break;case"off":event.currentTarget.blur()}["next","previous","off"].includes(e)||checkSelectorValidity(e)&&getRoot().querySelector(e).focus()},toggleExpanded=function(e,t,r){var n=getRoot(),a=n.querySelector(e),o=n.querySelector(t),i=void 0!==r?r:!!a&&"true"===a.getAttribute("aria-expanded");a?a.setAttribute("aria-expanded",!i):console.error("Error expanding the element: No parent item matched the selector."),o?o.setAttribute("aria-hidden",i):console.error("Error expanding the element: No child item matched the selector.")},_getExpanded=function(e){return"true"===("string"==typeof e?checkSelectorValidity(e)&&root.querySelector(e):e).getAttribute("aria-expanded")},focusTrap={externalElements:new Map,parentElement:null,isTrapped:!1},_toggleFocusTrap=function(e,t){focusTrap.parentElement="string"==typeof e?checkSelectorValidity(e)&&getRoot().querySelector(e):e;var r=getTabbableElements(),n=focusTrap.parentElement?r.filter((function(e){return!focusTrap.parentElement.contains(e)})):console.error("Error applying focus trap: No element matched the selector.")||[],a=focusTrap.externalElements;a.forEach((function(e,t){null!==e?t.setAttribute("tabindex",e):t.removeAttribute("tabindex"),a.delete(t)}));var o=void 0!==t?t:!focusTrap.isTrapped;o&&n.forEach((function(e){focusTrap.externalElements.set(e,e.getAttribute("tabindex")),e.setAttribute("tabindex","-1")})),focusTrap.isTrapped=o},getUtilities=function(e){return{focus:focus,toggleExpanded:toggleExpanded,getExpanded:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e;return _getExpanded(t)},toggleFocusTrap:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e;return _toggleFocusTrap(t)}}},updateKeyboardInteractivity=function(e){var t=getElementState(e),r=t.rules,n=t.methods;Object.keys(r).forEach((function(t){if(Events.removeAll(t),e.matches(t)){var a=r[t],o=a.keyboard,i=a.keyboardEvent;if(o){var u=getUtilities(e),c=Object.keys(o),l=i&&["keydown","keypress","keyup"].includes(i),s=l?i:"keydown";i&&!l&&logError('"'.concat(i,'" is not a valid keyboard event; using "keydown" instead.')),Events.add(t,s,(function(e){c.includes(e.key)&&o[e.key].forEach((function(t){return n[t](u,e)}))}))}}}))},updateMouseInteractivity=function(e){var t=getElementState(e),r=t.rules,n=t.methods;Object.keys(r).forEach((function(t){if(Events.removeAll(t),e.matches(t)){var a=r[t].mouse;if(a){var o=getUtilities(e),i=a.click,u=a.enter,c=a.leave,l=function(e,r){Events.add(t,r,(function(t){e.forEach((function(e){return n[e](o,t)}))}))};i&&l(i,"click"),u&&l(u,"mouseenter"),c&&l(c,"mouseleave")}}}))},updateScreenReaderText=function(e){var t=getElementState(e),r=t.rules,n=t.screenReaderElement,a=Object.keys(r).reverse().find((function(t){return e.matches(t)&&"string"==typeof r[t].screenReaderText}));if(!a)return n&&n.remove();var o=r[a].screenReaderText;updateElementState(e,(function(e){var t;return e.screenReaderElement=e.screenReaderElement||((t=document.createElement("span")).style="position:absolute;z-index:-9999999;opacity:0;",t),e})),t.screenReaderElement.remove(),t.screenReaderElement.textContent=o,e.insertBefore(t.screenReaderElement,e.firstChild)},updateFns={updateAttributes:updateAttributes,updateKeyboardInteractivity:updateKeyboardInteractivity,updateMouseInteractivity:updateMouseInteractivity,updateScreenReaderText:updateScreenReaderText},updateAll=function(e){updateFns.updateAttributes(e),updateFns.updateKeyboardInteractivity(e),updateFns.updateMouseInteractivity(e),updateFns.updateScreenReaderText(e),Events.update()},observerUtils={updateAttrsInState:function(e,t){t.forEach((function(t){var r=t?t.target.attributes[t.attributeName]:{};updateElementState(e,(function(e){var t=e.inlineAttributes.findIndex((function(e){return e.name===r.name})),n=-1!==t?t:e.inlineAttributes.length;return r?e.inlineAttributes[n]=r:swapAndPop(e.inlineAttributes,n),e}))}))},removeNonInlineAttrs:function(e){var t=getElementState(e).inlineAttributes;Array.from(e.attributes).forEach((function(r){var n=r.name;!!t.find((function(e){return e.name===n}))||e.removeAttribute(n)}))},updateChildElAttrs:function(e){var t=this;e.querySelectorAll("*").forEach((function(e){var r=getElementState(e).attributeObserver;r&&r.disconnect(),t.removeNonInlineAttrs(e),updateAll(e),r&&setTimeout((function(){return r.observe(e,{attributes:!0})}),0)}))},setAttrChangeCallback:function(e){var t=this;this.attrChangeCallback=function(r,n){n.disconnect();var a=r.filter((function(e){var t=e.target,r=e.attributeName;return t.attributes[r]}));t.updateAttrsInState(e,a),t.removeNonInlineAttrs(e),updateAll(e),t.updateChildElAttrs(e),setTimeout((function(){n.observe(e,{attributes:!0})}),0)}},attrChangeCallback:null},watchAttributesForChanges=function(e){observerUtils.setAttrChangeCallback(e);var t=new MutationObserver(observerUtils.attrChangeCallback);t.observe(e,{attributes:!0}),updateElementState(e,(function(e){return e.attributeObserver=t,e}))},ruleUtilities={setApplyRulesCallback:function(e){var t=Object.keys(e.rules).sort(compare);this.applyRulesCallback=function(r){return t.forEach((function(t){if(r&&!_toConsumableArray(r.find((function(e){return e.addedNodes})).addedNodes).some((function(e){return e instanceof HTMLElement&&e.matches(t)})))return;checkSelectorValidity(t)&&getRoot().querySelectorAll(t).forEach((function(r){var n=e.rules,a=e.methods,o=n&&n[t]||{};updateElementState(r,(function(e){return e.rules[t]=o,e.methods=a,e})),updateAll(r),watchAttributesForChanges(r)}))}))}},applyRulesCallback:null,observer:null},addAccessibilityRules=function(e){var t=e?e.constructor.name:String(e);e&&e.constructor===Object||throwError("Expected Object, but got ".concat(t)),rootObj.element=e.root;var r=e.rules||{},n=e.methods||{};r.constructor===Object&&n.constructor===Object||throwError("The `rules` and `methods` properties must be objects."),ruleUtilities.setApplyRulesCallback(e),ruleUtilities.observer=new MutationObserver(ruleUtilities.applyRulesCallback),ruleUtilities.observer.observe(getRoot(),{childList:!0,subtree:!0}),ruleUtilities.applyRulesCallback()};exports.addAccessibilityRules=addAccessibilityRules,exports.default=addAccessibilityRules;